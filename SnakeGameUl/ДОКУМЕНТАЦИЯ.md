# Полная документация проекта SnakeGameUI

## Обзор архитектуры

Проект представляет собой консольную игру "Змейка" на C#, построенную по принципам объектно-ориентированного программирования. Проект организован в модульную структуру с разделением по пространствам имен:

- **SnakeGameUl.Core** - базовые компоненты
- **SnakeGameUl.Game** - игровая логика
- **SnakeGameUl.UI** - пользовательский интерфейс
- **SnakeGameUl.Audio** - звуковая система

Используется библиотека **NAudio** для профессиональной работы со звуком.

## Основные классы и их функции

### 1. Program.cs - Главный класс приложения

**Назначение**: Точка входа в приложение и управление основным игровым циклом.

#### Main(string[] args) - Главная функция
**Что делает**: Управляет полным жизненным циклом игры от запуска до завершения.

**Сложная логика**:
```csharp
while (true) // Основной цикл перезапуска игры
{
    // Инициализация звуковой системы
    string basePath = AppDomain.CurrentDomain.BaseDirectory;
    MusicManager.Initialize(basePath);
    
    // Создание игрока с системой жизней
    Player player = new Player(playerName, startPoint, Direction.RIGHT);
    player.Stats.LifeSystem = new LifeSystem(3);
    
    // Внутренний игровой цикл
    while (true)
    {
        // Проверка столкновений и система жизней
        if (walls.IsHit(player.Snake) || player.Snake.IsHitTail())
        {
            if (player.Stats.LifeSystem.LoseLife()) // Есть еще жизни
            {
                // Перезапуск с новой змейкой
                player.Stats.ResetAfterDeath();
                startPoint = new Point(4, 5 + gameOffsetY, '*');
                player.Snake = new Snake(startPoint, 4, Direction.RIGHT);
                continue; // Продолжаем игру
            }
            else
            {
                break; // Завершаем игру
            }
        }
    }
}
```

**Как работает**:
- `MusicManager.Initialize()` подготавливает звуковую систему перед началом игры
- `Player` создается с привязкой к `LifeSystem` для управления жизнями
- `walls.IsHit()` и `player.Snake.IsHitTail()` проверяют условия потери жизни
- `player.Stats.LifeSystem.LoseLife()` определяет, продолжать игру или завершить

#### WriteGameOver() - Отображение экрана окончания игры
**Что делает**: Выводит ASCII-арт сообщение об окончании игры.

#### WriteText(String text, int xOffset, int yOffset) - Вывод текста
**Что делает**: Устанавливает курсор в указанную позицию и выводит текст.

### 2. LifeSystem.cs - Система управления жизнями

**Назначение**: Управляет количеством жизней игрока и их отображением.

#### LoseLife() - Потеря жизни
```csharp
public bool LoseLife()
{
    Lives--;
    return Lives > 0; // Возвращает true если игра продолжается
}
```
**Что делает**: Уменьшает количество жизней на 1 и возвращает информацию о том, может ли игра продолжаться.

#### GainLife() - Получение дополнительной жизни
```csharp
public void GainLife()
{
    Lives++;
    if (Lives > MaxLives)
        MaxLives = Lives;
}
```
**Что делает**: Увеличивает количество жизней и обновляет максимальное значение при необходимости.

#### DisplayLives() - Отображение жизней
```csharp
public void DisplayLives()
{
    Console.SetCursorPosition(60, 1); // Позиция на экране
    Console.Write($"Elud: ");
    
    // Показываем все заработанные жизни
    for (int i = 0; i < MaxLives; i++)
    {
        if (i < Lives)
            Console.Write("♥ "); // Заполненное сердце
        else
            Console.Write("♡ "); // Пустое сердце
    }
    Console.Write($" ({Lives}/{MaxLives})   ");
}
```
**Сложные фрагменты**:
- `Console.SetCursorPosition(60, 1)` - устанавливает курсор в правый верхний угол
- Цикл `for` отображает визуальное представление жизней через символы сердец
- `i < Lives` определяет, показывать заполненное или пустое сердце
- `({Lives}/{MaxLives})` показывает точное количество жизней

#### ShowLifeLostMessage() - Сообщение о потере жизни
```csharp
public void ShowLifeLostMessage()
{
    Console.SetCursorPosition(25, 12);
    Console.Write($"KAOTASID ELU! Jäänud elusid: {Lives}");
    System.Threading.Thread.Sleep(1500); // Пауза 1.5 секунды
    
    Console.SetCursorPosition(25, 12);
    Console.Write(new string(' ', 35)); // Очистка сообщения
}
```
**Что делает**: Показывает временное сообщение о потере жизни, затем очищает его.

#### ShowLifeGainedMessage() - Сообщение о получении жизни
**Что делает**: Показывает сообщение "LISAELU SAADUD!" на 1 секунду, затем очищает.

#### HasLives() - Проверка наличия жизней
**Что делает**: Возвращает true, если у игрока есть жизни.

#### Reset() - Сброс жизней
**Что делает**: Восстанавливает количество жизней до максимального значения.

### 3. Snake.cs - Класс змейки

**Назначение**: Основной игровой объект, управляет движением и логикой змейки.

#### Конструктор Snake(Point tail, int length, Direction _direction)
```csharp
public Snake(Point tail, int length, Direction _direction)
{
    direction = _direction;
    pList = new List<Point>(); // Список сегментов змейки
    for (int i = 0; i < length; i++)
    {
        Point p = new Point(tail);
        p.Move(i, direction); // Создание сегмента со смещением
        pList.Add(p);
    }
}
```
**Сложные фрагменты**:
- `pList` - список точек, представляющих сегменты змейки
- `p.Move(i, direction)` - каждый сегмент смещается на i позиций от хвоста
- Змейка создается "растянутой" в противоположном направлении движения

#### Move() - Движение змейки
```csharp
public void Move()
{
    Point tail = pList.First(); // Получаем хвост
    pList.Remove(tail); // Удаляем хвост из списка
    Point head = GetNextPoint(); // Вычисляем новую голову
    pList.Add(head); // Добавляем новую голову
    
    tail.Clear(); // Стираем хвост с экрана
    head.Draw(); // Рисуем новую голову
}
```
**Что делает**: Реализует движение змейки путем удаления хвоста и добавления новой головы.

**Связь функций**:
- `pList.First()` и `pList.Last()` работают с концами змейки
- `GetNextPoint()` вычисляет следующую позицию головы
- `tail.Clear()` и `head.Draw()` обновляют визуальное отображение

#### GetNextPoint() - Вычисление следующей позиции
**Что делает**: Возвращает точку, где будет находиться голова змейки на следующем шаге.

#### IsHitTail() - Проверка столкновения с хвостом
```csharp
public bool IsHitTail()
{
    var head = pList.Last();
    for(int i = 0; i < pList.Count - 2; i++ )
    {
        if ( head.IsHit( pList[ i ] ) )
            return true;
    }
    return false;
}
```
**Сложная логика**: Проверяет столкновение головы с каждым сегментом тела, исключая саму голову и шею (`pList.Count - 2`).

#### HandleKey(ConsoleKey key) - Обработка клавиш
```csharp
public void HandleKey(ConsoleKey key)
{
    Direction newDirection = direction;
    
    if (key == ConsoleKey.LeftArrow && direction != Direction.RIGHT)
        newDirection = Direction.LEFT;
    // ... остальные направления
        
    direction = newDirection;
}
```
**Важная логика**: Проверка `direction != Direction.RIGHT` предотвращает движение змейки в противоположном направлении (самоубийство).

#### Eat(Point food) - Поедание еды
```csharp
public bool Eat(Point food)
{
    Point head = GetNextPoint(); // Следующая позиция головы
    if (head.IsHit(food)) // Проверка столкновения с едой
    {
        Point newHead = new Point(food.x, food.y, head.sym);
        pList.Add(newHead); // Добавляем голову БЕЗ удаления хвоста
        return true; // Еда съедена
    }
    else
        return false; // Еда не съедена
}
```
**Сложная логика**: При поедании еды хвост НЕ удаляется, что приводит к росту змейки на один сегмент.

### 4. Stats.cs - Система статистики

**Назначение**: Управляет очками, статистикой игрока и интеграцией с системой жизней.

#### UpdateScore(int points = 10) - Обновление счета
```csharp
public void UpdateScore(int points = 10)
{
    int oldScore = Score;
    Score += points;
    Length++;
    
    // Проверка на получение дополнительной жизни
    if (oldScore / 100 < Score / 100 && LifeSystem != null)
    {
        LifeSystem.GainLife();
        LifeSystem.ShowLifeGainedMessage();
    }
}
```
**Сложная логика**:
- `oldScore / 100 < Score / 100` - проверяет, пересек ли счет границу в 100 очков
- Целочисленное деление используется для определения "сотен" очков
- При пересечении границы игрок получает дополнительную жизнь

#### PrintStats() - Отображение статистики
```csharp
public void PrintStats()
{
    try
    {
        Console.SetCursorPosition(0, 0);
        string statsLine = $"Nimi: {Name,-15} Skoor: {Score,-6} Pikkus: {Length,-4} Rekord: {HighScore,-6} Tase: {Level}";
        Console.Write(statsLine.PadRight(Console.WindowWidth - 1));
        
        LifeSystem?.DisplayLives(); // Отображение жизней
    }
    catch (ArgumentOutOfRangeException) { }
}
```
**Сложные фрагменты**:
- `{Name,-15}` - форматирование с выравниванием по левому краю на 15 символов
- `PadRight(Console.WindowWidth - 1)` - заполнение строки до ширины консоли
- `LifeSystem?.DisplayLives()` - безопасный вызов с проверкой на null

#### ResetAfterDeath() - Сброс после смерти
**Что делает**: Сбрасывает длину змейки до начального значения (4).

#### UpdateHighScore() - Обновление рекорда
**Что делает**: Обновляет рекорд, если текущий счет больше предыдущего рекорда.

#### LoadStats() - Загрузка статистики
**Что делает**: Загружает сохраненную статистику из файла "stats.txt".

#### SaveStats() - Сохранение статистики
**Что делает**: Сохраняет текущую статистику в файл "stats.txt".

#### SaveToLeaderboard() - Сохранение в таблицу лидеров
**Что делает**: Добавляет результат игрока в файл "leaderboard.txt".

#### ShowLeaderboard() - Отображение таблицы лидеров
```csharp
public static void ShowLeaderboard()
{
    // Загрузка и сортировка результатов
    var scores = new List<(string name, int score)>();
    foreach (var line in lines)
    {
        var parts = line.Split(',');
        if (parts.Length == 2 && int.TryParse(parts[1], out int score))
        {
            scores.Add((parts[0], score));
        }
    }
    
    scores.Sort((a, b) => b.score.CompareTo(a.score)); // Сортировка по убыванию
    
    // Отображение топ-5
    for (int i = 0; i < Math.Min(5, scores.Count); i++)
    {
        Console.WriteLine($"{i + 1}. {scores[i].name} - {scores[i].score}");
    }
}
```
**Сложная логика**: Парсинг CSV-файла, сортировка по убыванию счета и отображение топ-5 результатов.



### 5. Player.cs - Класс игрока

**Назначение**: Связующий класс между змейкой и статистикой.

```csharp
class Player
{
    public string Name { get; set; }
    public Stats Stats { get; set; }
    public Snake Snake { get; set; }
    
    public Player(string name, Point startPosition, Direction direction)
    {
        Name = name;
        Stats = new Stats { Name = name };
        Snake = new Snake(startPosition, 4, direction);
    }
}
```

**Связь компонентов**: Player объединяет Snake (игровую логику) и Stats (статистику), обеспечивая единую точку доступа к данным игрока.

### 6. Point.cs - Класс точки

**Назначение**: Представляет точку на игровом поле с координатами и символом.

#### Основные функции:
- `Draw()` - отрисовка точки на экране
- `Clear()` - очистка точки с экрана
- `IsHit(Point p)` - проверка столкновения с другой точкой
- `Move(int offset, Direction direction)` - перемещение точки

### 7. Figure.cs - Базовый класс фигур

**Назначение**: Абстрактный базовый класс для всех игровых объектов.

#### Основные функции:
- `Draw()` - отрисовка всех точек фигуры
- `IsHit(Figure figure)` - проверка столкновения с другой фигурой

### 8. Walls.cs - Класс стен

**Назначение**: Управляет границами игрового поля и препятствиями.

#### Основные функции:
- `Draw()` - отрисовка всех стен
- `IsHit(Figure figure)` - проверка столкновения со стенами
- `AddObstacle(int x, int y, int length)` - добавление препятствий

### 9. FoodCreator.cs - Генератор еды

**Назначение**: Создает еду в случайных местах игрового поля.

#### CreateFood() - Создание еды
**Сложная логика**: Генерирует случайные координаты и проверяет, что еда не появляется внутри стен или змейки.

### 10. Direction.cs - Перечисление направлений

**Назначение**: Определяет возможные направления движения.

```csharp
enum Direction
{
    LEFT,
    RIGHT,
    UP,
    DOWN
}
```

### 11. MusicManager.cs (Audio/SoundManager.cs) - Управление звуком

**Назначение**: Управляет воспроизведением звуковых эффектов и фоновой музыки через NAudio.

#### Основные функции:
- `Initialize(string basePath)` - инициализация звуковой системы NAudio
- `StartBackgroundMusic()` - запуск фоновой музыки (75% громкости)
- `PlayEatSound()` - звук поедания еды
- `PlayLifeSound()` - звук возрождения при потере жизни
- `PlayEndSound()` - звук полной смерти (останавливает фоновую музыку)
- `Dispose()` - освобождение ресурсов NAudio

#### Архитектура звуковой системы:
```csharp
private static WaveOutEvent backgroundPlayer;  // Фоновая музыка
private static WaveOutEvent effectPlayer;      // Звуки еды
private static WaveOutEvent lifePlayer;        // Звуки возрождения
private static WaveOutEvent endPlayer;         // Звуки смерти
```

**Особенности**:
- Фоновая музыка играет в цикле с автоматическим перезапуском
- Каждый тип звука использует отдельный плеер для избежания конфликтов
- Громкость фоновой музыки установлена на 75% (`backgroundMusic.Volume = 0.75f`)
- При полной смерти фоновая музыка останавливается

#### Звуковые файлы:
- **background.wav** - фоновая музыка
- **eat.wav** - звук поедания еды
- **life.wav** - звук возрождения
- **end.wav** - звук полной смерти

## Взаимодействие между классами

### Цепочка обработки столкновения:
1. **Program.Main()** проверяет столкновение через `walls.IsHit()` и `snake.IsHitTail()`
2. При столкновении вызывается **LifeSystem.LoseLife()**
3. Если жизни остались, **LifeSystem.ShowLifeLostMessage()** показывает сообщение
4. **Stats.ResetAfterDeath()** сбрасывает длину змейки
5. Создается новый объект **Snake** с начальными параметрами
6. Игра продолжается с обновленным отображением

### Цепочка получения очков:
1. **Snake.Eat()** определяет поедание еды
2. **Stats.UpdateScore()** увеличивает счет
3. Внутри **UpdateScore()** проверяется условие для дополнительной жизни
4. При необходимости вызывается **LifeSystem.GainLife()**
5. **Stats.PrintStats()** обновляет отображение статистики

### Система жизней - ключевые особенности:
- Игрок начинает с 3 жизнями
- За каждые 100 очков игрок получает дополнительную жизнь
- Максимальное количество жизней увеличивается автоматически
- При потере жизни змейка сбрасывается, но счет сохраняется
- Игра заканчивается только при потере всех жизней

### Архитектурные принципы:
- **Разделение ответственности**: каждый класс отвечает за свою область
- **Модульная структура**: код организован по пространствам имен
- **Инкапсуляция**: внутренняя логика скрыта за публичными интерфейсами
- **Модульность**: компоненты легко заменяются и тестируются
- **Расширяемость**: легко добавлять новые функции без изменения существующего кода
- **Профессиональная звуковая система**: использование NAudio для качественного воспроизведения

### Новые возможности:
- **Структурированная архитектура** с разделением по папкам
- **Профессиональная звуковая система** на базе NAudio
- **Многоканальное воспроизведение** звуков без конфликтов
- **Автоматический перезапуск** фоновой музыки
- **Контроль громкости** фоновой музыки
- **Звуковая обратная связь** для всех игровых событий

## Файловая структура проекта

### Корневая папка:
- **Program.cs** - точка входа и основной игровой цикл
- **SnakeGameUl.csproj** - файл проекта с зависимостями
- **stats.txt** - сохраненная статистика
- **leaderboard.txt** - таблица лидеров
- **ДОКУМЕНТАЦИЯ.md** - данная документация

### Core/ (SnakeGameUl.Core)
- **Point.cs** - базовый класс для точек на поле
- **Figure.cs** - абстрактный класс для игровых объектов
- **Direction.cs** - перечисление направлений

### Game/ (SnakeGameUl.Game)
- **Player.cs** - класс игрока, объединяющий змейку и статистику
- **Snake.cs** - логика движения и поведения змейки
- **Stats.cs** - система счета, статистики и сохранения
- **LifeSystem.cs** - система управления жизнями
- **FoodCreator.cs** - генерация еды

### UI/ (SnakeGameUl.UI)
- **Walls.cs** - управление границами и препятствиями
- **HorizontaleLine.cs** - горизонтальные линии
- **VerticalLine.cs** - вертикальные линии

### Audio/ (SnakeGameUl.Audio)
- **SoundManager.cs** - управление звуком через NAudio

### assets/
- **background.wav** - фоновая музыка
- **eat.wav** - звук поедания еды
- **life.wav** - звук возрождения
- **end.wav** - звук полной смерти

### Зависимости:
- **NAudio** (v2.2.1) - библиотека для работы со звуком